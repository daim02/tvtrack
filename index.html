<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVTrack</title>

  <!-- iOS viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <!-- iPhone Home Screen behavior -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="TVTrack">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Icon for Add to Home Screen -->
  <link rel="apple-touch-icon" href="tvicon.png">

  <!-- Prevent auto phone detection -->
  <meta name="format-detection" content="telephone=no">

  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --border: #e3e3e8;
      --border-subtle: #ececf0;
      --accent: #007aff;
      --text-main: #111111;
      --text-muted: #7a7a85;
      --danger: #ff3b30;
      --radius-lg: 12px;
      --radius-sm: 9px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      -webkit-text-size-adjust: 100%; /* stop Safari from resizing text */
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 720px;
      padding: 18px 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      padding-top: env(safe-area-inset-top);
      padding-bottom: 10px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }

    header h1 {
      margin: 0;
      font-size: 1.22rem;
      font-weight: 600;
    }

    header span {
      font-size: 0.70rem;
      color: var(--text-muted);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 12px 14px;
    }

    .card-header {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .card-sub {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    form {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px 10px;
      align-items: flex-end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .field-show {
      grid-column: span 4;
    }

    .field-wide {
      grid-column: span 2;
    }

    input[type="text"],
    input[type="number"] {
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 16px;          /* important: >= 16px so iOS does not zoom */
      background: #ffffff;
      height: 42px;
      outline: none;
    }

    input::placeholder {
      color: #c1c1c7;
    }

    input:focus {
      border-color: var(--accent);
    }

    .buttons-row {
      grid-column: span 4;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 4px;
    }

    button {
      font-family: inherit;
      height: 42px;
    }

    .btn-primary {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #ffffff;
      font-size: 0.86rem;
      font-weight: 600;
      padding: 0 18px;
      cursor: pointer;
    }

    .btn-primary:active {
      opacity: 0.85;
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f2f2f7;
      color: var(--text-main);
      font-size: 0.82rem;
      padding: 0 16px;
      cursor: pointer;
    }

    .btn-secondary:active {
      background: #e5e5ea;
    }

    .hint {
      font-size: 0.76rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .list-wrapper {
      margin-top: 8px;
    }

    .list-card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #ffffff;
      overflow: hidden;
    }

    .empty {
      padding: 24px;
      font-size: 0.88rem;
      color: var(--text-muted);
      text-align: center;
    }

    .empty span {
      display: block;
      font-size: 1.6rem;
      margin-bottom: 6px;
    }

    .show-row {
      display: flex;
      align-items: center;
      padding: 14px 12px;
      gap: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .show-row:first-child {
      border-top: 0;
    }

    .show-main {
      flex: 1;
      min-width: 0;
      text-align: left;
      border: 0;
      background: transparent;
      cursor: pointer;
      padding: 0;
    }

    .show-title {
      font-size: 0.96rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .show-meta {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .show-meta strong {
      color: var(--accent);
      font-weight: 500;
    }

    .row-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-danger {
      border-radius: 8px;
      border: 1px solid var(--danger);
      background: #fff5f5;
      color: var(--danger);
      padding: 0 12px;
      font-size: 0.8rem;
      cursor: pointer;
      height: 34px;
    }

    @media (max-width: 520px) {
      form {
        grid-template-columns: repeat(2, 1fr);
      }

      .field-show {
        grid-column: span 2;
      }

      .field-wide {
        grid-column: span 2;
      }

      .buttons-row {
        grid-column: span 2;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <h1>TVTrack</h1>
      <span>Local only Â· No login</span>
    </header>

    <main>
      <!-- FORM CARD -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">Now watching</div>
          <div class="card-sub" id="form-status"></div>
        </div>

        <form id="show-form">
          <input type="hidden" id="editing-id">

          <div class="field field-show">
            <label for="show-name">Show</label>
            <input id="show-name" type="text" placeholder="Better Call Saul" required>
          </div>

          <div class="field">
            <label for="season">Season</label>
            <input id="season" type="number" min="1" placeholder="1">
          </div>

          <div class="field">
            <label for="episode">Episode</label>
            <input id="episode" type="number" min="1" placeholder="1">
          </div>

          <div class="field field-wide">
            <label for="timestamp">Time in episode</label>
            <input id="timestamp" type="text" placeholder="mm:ss or minutes (optional)">
          </div>

          <div class="buttons-row">
            <button type="button" class="btn-secondary" id="clear-form-btn">Clear</button>
            <button type="submit" class="btn-primary">
              <span id="save-btn-label">Save position</span>
            </button>
          </div>
        </form>

        <p class="hint">Tip: Tap a show in the list to edit your progress.</p>
      </section>

      <!-- LIST -->
      <section class="list-wrapper">
        <div class="card-title" style="margin-left: 4px;">Your shows</div>
        <div class="list-card">
          <div id="shows-container"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "tv-tracker-shows-v3";
      let shows = [];

      const form = document.getElementById("show-form");
      const showNameInput = document.getElementById("show-name");
      const seasonInput = document.getElementById("season");
      const episodeInput = document.getElementById("episode");
      const timestampInput = document.getElementById("timestamp");
      const editingIdInput = document.getElementById("editing-id");
      const showsContainer = document.getElementById("shows-container");
      const saveBtnLabel = document.getElementById("save-btn-label");
      const clearBtn = document.getElementById("clear-form-btn");
      const formStatus = document.getElementById("form-status");

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) shows = JSON.parse(raw);
        } catch {}
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(shows));
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function meta(show) {
        const parts = [];
        if (show.season) parts.push("S" + show.season);
        if (show.episode) parts.push("E" + show.episode);
        if (show.timestamp && show.timestamp.trim()) {
          parts.push(show.timestamp.trim());
        }
        return parts.join(" Â· ");
      }

      function render() {
        if (!shows.length) {
          showsContainer.innerHTML =
            '<div class="empty"><span>ðŸ“º</span>Add your first show above.</div>';
          return;
        }

        const sorted = [...shows].sort((a, b) => b.lastUpdated - a.lastUpdated);

        showsContainer.innerHTML = sorted
          .map(
            (s) => `
          <div class="show-row" data-id="${s.id}">
            <button class="show-main" data-action="edit">
              <div class="show-title">${escapeHtml(s.name)}</div>
              <div class="show-meta">
                ${
                  meta(s)
                    ? `<strong>${escapeHtml(meta(s))}</strong>`
                    : `<span class="pill">No details yet</span>`
                }
              </div>
            </button>
            <div class="row-actions">
              <button class="btn-danger" data-action="delete">Delete</button>
            </div>
          </div>
        `
          )
          .join("");
      }

      function resetForm() {
        form.reset();
        editingIdInput.value = "";
        saveBtnLabel.textContent = "Save position";
        formStatus.textContent = "";
      }

      function fillForm(show) {
        showNameInput.value = show.name;
        seasonInput.value = show.season || "";
        episodeInput.value = show.episode || "";
        timestampInput.value = show.timestamp || "";
        editingIdInput.value = show.id;
        saveBtnLabel.textContent = "Update";
        formStatus.textContent = "Editing â€œ" + show.name + "â€";
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const name = showNameInput.value.trim();
        if (!name) {
          alert("Please enter a show name.");
          return;
        }

        const id = editingIdInput.value;
        const now = Date.now();

        const season = seasonInput.value ? parseInt(seasonInput.value, 10) : null;
        const episode = episodeInput.value ? parseInt(episodeInput.value, 10) : null;
        const timestamp = timestampInput.value.trim();

        if (id) {
          const idx = shows.findIndex((s) => s.id === id);
          if (idx !== -1) {
            shows[idx] = { ...shows[idx], name, season, episode, timestamp, lastUpdated: now };
          }
        } else {
          shows.push({
            id: "id-" + now + "-" + Math.random().toString(16).slice(2),
            name,
            season,
            episode,
            timestamp,
            lastUpdated: now,
          });
        }

        save();
        render();
        resetForm();
      });

      clearBtn.addEventListener("click", resetForm);

      showsContainer.addEventListener("click", (e) => {
        const row = e.target.closest(".show-row");
        if (!row) return;

        const id = row.dataset.id;
        const action = e.target.dataset.action || "edit";

        if (action === "delete") {
          const show = shows.find((s) => s.id === id);
          if (confirm(`Delete â€œ${show ? show.name : "this show"}â€?`)) {
            shows = shows.filter((s) => s.id !== id);
            save();
            render();
            if (editingIdInput.value === id) resetForm();
          }
        } else {
          const show = shows.find((s) => s.id === id);
          if (show) fillForm(show);
        }
      });

      load();
      render();
    })();
  </script>
</body>
</html>
