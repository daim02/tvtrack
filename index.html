<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TVTrack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- iOS home-screen style -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --border: #e3e3e8;
      --border-subtle: #ececf0;
      --accent: #007aff;
      --accent-soft: #e5f1ff;
      --text-main: #111111;
      --text-muted: #7a7a85;
      --danger: #ff3b30;
      --radius-lg: 12px;
      --radius-sm: 9px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 720px;
      padding: 16px 14px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      padding-top: env(safe-area-inset-top);
      padding-bottom: 4px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    header span {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 12px 12px 10px;
    }

    .card + .card {
      margin-top: 2px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 0.82rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .card-sub {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    form {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px 10px;
      align-items: flex-end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .field-show {
      grid-column: span 4;
    }

    .field-wide {
      grid-column: span 2;
    }

    input[type="text"],
    input[type="number"] {
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      padding: 8px 9px;
      font-size: 0.9rem;
      background: #ffffff;
      color: var(--text-main);
      outline: none;
    }

    input::placeholder {
      color: #c1c1c7;
    }

    input:focus {
      border-color: var(--accent);
    }

    .buttons-row {
      grid-column: span 4;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 2px;
    }

    button {
      font-family: inherit;
    }

    .btn-primary {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #ffffff;
      font-size: 0.86rem;
      font-weight: 600;
      padding: 7px 14px;
      cursor: pointer;
      min-height: 32px;
    }

    .btn-primary:active {
      opacity: 0.8;
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f2f2f7;
      color: var(--text-main);
      font-size: 0.82rem;
      padding: 7px 10px;
      cursor: pointer;
      min-height: 32px;
    }

    .btn-secondary:active {
      background: #e5e5ea;
    }

    .btn-ghost {
      border: 0;
      background: transparent;
      color: var(--accent);
      font-size: 0.8rem;
      padding: 4px 6px;
      cursor: pointer;
    }

    .btn-danger {
      border-radius: 999px;
      border: 1px solid var(--danger);
      background: #fff5f5;
      color: var(--danger);
      font-size: 0.8rem;
      padding: 5px 10px;
      cursor: pointer;
      min-height: 30px;
    }

    .hint {
      font-size: 0.76rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .list-wrapper {
      margin-top: 4px;
    }

    .list-card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #ffffff;
      overflow: hidden;
    }

    .empty {
      padding: 16px 12px;
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
    }

    .empty span {
      display: block;
      font-size: 1.6rem;
      margin-bottom: 4px;
    }

    .show-row {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      gap: 10px;
      border-top: 1px solid var(--border-subtle);
    }

    .show-row:first-child {
      border-top: 0;
    }

    .show-main {
      flex: 1;
      min-width: 0;
      text-align: left;
      padding: 0;
      border: 0;
      background: transparent;
      cursor: pointer;
    }

    .show-title {
      font-size: 0.98rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .show-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .show-meta strong {
      color: var(--accent);
      font-weight: 500;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.72rem;
      color: var(--text-muted);
      background: #f5f5f7;
    }

    .row-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    @media (max-width: 520px) {
      .app {
        padding: 10px 10px 18px;
      }

      header h1 {
        font-size: 1.25rem;
      }

      form {
        grid-template-columns: repeat(2, 1fr);
      }

      .field-show {
        grid-column: span 2;
      }

      .field-wide {
        grid-column: span 2;
      }

      .buttons-row {
        grid-column: span 2;
        justify-content: flex-start;
      }

      .btn-primary {
        flex: 1;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>TVTrack</h1>
      <span>Local only Â· No login</span>
    </header>

    <main>
      <!-- FORM CARD -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">Now watching</div>
          <div class="card-sub" id="form-status"></div>
        </div>

        <form id="show-form">
          <input type="hidden" id="editing-id" value="" />

          <div class="field field-show">
            <label for="show-name">Show</label>
            <input
              id="show-name"
              type="text"
              autocomplete="off"
              placeholder="Better Call Saul"
              required
            />
          </div>

          <div class="field">
            <label for="season">Season</label>
            <input
              id="season"
              type="number"
              inputmode="numeric"
              min="1"
              step="1"
              placeholder="1"
            />
          </div>

          <div class="field">
            <label for="episode">Episode</label>
            <input
              id="episode"
              type="number"
              inputmode="numeric"
              min="1"
              step="1"
              placeholder="1"
            />
          </div>

          <div class="field field-wide">
            <label for="timestamp">Time in episode</label>
            <input
              id="timestamp"
              type="text"
              inputmode="decimal"
              placeholder="mm:ss or minutes (optional)"
            />
          </div>

          <div class="buttons-row">
            <button type="button" class="btn-secondary" id="clear-form-btn">
              Clear
            </button>
            <button type="submit" class="btn-primary">
              <span id="save-btn-label">Save position</span>
            </button>
          </div>
        </form>

        <p class="hint">
          Tip: Tap a show in the list to load it into the form and update your progress.
        </p>
      </section>

      <!-- LIST CARD -->
      <section class="list-wrapper">
        <div class="card-header" style="padding: 0 2px 6px;">
          <div class="card-title">Your shows</div>
        </div>

        <div class="list-card" id="shows-card">
          <div id="shows-container"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "tv-tracker-shows-v2";

      /** @type {Array<{id:string,name:string,season:number|null,episode:number|null,timestamp:string,lastUpdated:number}>} */
      let shows = [];

      const form = document.getElementById("show-form");
      const showNameInput = document.getElementById("show-name");
      const seasonInput = document.getElementById("season");
      const episodeInput = document.getElementById("episode");
      const timestampInput = document.getElementById("timestamp");
      const editingIdInput = document.getElementById("editing-id");
      const showsContainer = document.getElementById("shows-container");
      const clearFormBtn = document.getElementById("clear-form-btn");
      const saveBtnLabel = document.getElementById("save-btn-label");
      const formStatus = document.getElementById("form-status");

      function loadShows() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            shows = parsed;
          }
        } catch (err) {
          console.error("Failed to load shows", err);
        }
      }

      function saveShows() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(shows));
        } catch (err) {
          console.error("Failed to save shows", err);
          alert("Could not save data. Storage might be full.");
        }
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatMeta(show) {
        const parts = [];
        if (show.season) parts.push("S" + show.season);
        if (show.episode) parts.push("E" + show.episode);
        if (show.timestamp && show.timestamp.trim() !== "") {
          parts.push(show.timestamp.trim());
        }
        return parts.join(" Â· ");
      }

      function renderShows() {
        if (!shows.length) {
          showsContainer.innerHTML =
            '<div class="empty"><span>ðŸ“º</span>Add your first show above.</div>';
          return;
        }

        const sorted = [...shows].sort((a, b) => b.lastUpdated - a.lastUpdated);

        const html = sorted
          .map((show) => {
            const meta = formatMeta(show);
            const hasProgress = Boolean(meta);
            return `
              <div class="show-row" data-id="${show.id}">
                <button class="show-main" data-action="edit">
                  <div class="show-title">${escapeHtml(show.name)}</div>
                  <div class="show-meta">
                    ${
                      hasProgress
                        ? `<strong>${escapeHtml(meta)}</strong>`
                        : `<span class="pill">No details yet</span>`
                    }
                  </div>
                </button>
                <div class="row-actions">
                  <button class="btn-ghost" data-action="edit">Edit</button>
                  <button class="btn-danger" data-action="delete">Delete</button>
                </div>
              </div>
            `;
          })
          .join("");

        showsContainer.innerHTML = html;
      }

      function resetForm() {
        form.reset();
        editingIdInput.value = "";
        saveBtnLabel.textContent = "Save position";
        formStatus.textContent = "";
        showNameInput.focus();
      }

      function fillFormFromShow(show) {
        showNameInput.value = show.name || "";
        seasonInput.value = show.season || "";
        episodeInput.value = show.episode || "";
        timestampInput.value = show.timestamp || "";
        editingIdInput.value = show.id;
        saveBtnLabel.textContent = "Update";
        formStatus.textContent = "Editing â€œ" + show.name + "â€";
        showNameInput.focus();
      }

      form.addEventListener("submit", function (event) {
        event.preventDefault();

        const name = showNameInput.value.trim();
        if (!name) {
          alert("Please enter a show name.");
          return;
        }

        const seasonRaw = seasonInput.value.trim();
        const episodeRaw = episodeInput.value.trim();
        const timestamp = timestampInput.value.trim();

        const season = seasonRaw ? Math.max(1, parseInt(seasonRaw, 10) || 1) : null;
        const episode = episodeRaw ? Math.max(1, parseInt(episodeRaw, 10) || 1) : null;
        const idFromForm = editingIdInput.value || null;
        const now = Date.now();

        if (idFromForm) {
          const index = shows.findIndex((s) => s.id === idFromForm);
          if (index !== -1) {
            shows[index] = {
              ...shows[index],
              name,
              season,
              episode,
              timestamp,
              lastUpdated: now,
            };
          }
        } else {
          const newShow = {
            id: "show-" + now + "-" + Math.random().toString(16).slice(2),
            name,
            season,
            episode,
            timestamp,
            lastUpdated: now,
          };
          shows.push(newShow);
        }

        saveShows();
        renderShows();
        resetForm();
      });

      clearFormBtn.addEventListener("click", function () {
        resetForm();
      });

      showsContainer.addEventListener("click", function (event) {
        const target = event.target;
        const row = target.closest(".show-row");
        if (!row) return;

        const id = row.getAttribute("data-id");
        if (!id) return;

        const action = target.getAttribute("data-action") || "edit";

        if (action === "delete") {
          const show = shows.find((s) => s.id === id);
          const confirmed = confirm(
            `Delete â€œ${show ? show.name : "this show"}â€ from your list?`
          );
          if (!confirmed) return;
          shows = shows.filter((s) => s.id !== id);
          saveShows();
          renderShows();
          if (editingIdInput.value === id) {
            resetForm();
          }
        } else if (action === "edit") {
          const show = shows.find((s) => s.id === id);
          if (!show) return;
          fillFormFromShow(show);
        }
      });

      // Initial load
      loadShows();
      renderShows();
      showNameInput.focus();
    })();
  </script>
</body>
</html>
